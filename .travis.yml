# Based on the "trust" template v0.1.2
# https://github.com/japaric/trust/tree/v0.1.2

dist: trusty
language: rust
services: docker
sudo: required

env:
  global:
    - CRATE_NAME=anon-csv

matrix:
  include:
    - env: ENABLE_TESTS=1
    # Linux
    # fails as /usr/bin/file can't be found. Fair enough
    # - env: TARGET=i686-unknown-linux-musl
    - env: TARGET=x86_64-unknown-linux-musl

    # OSX
    - env: TARGET=i686-apple-darwin
      os: osx
    - env: TARGET=x86_64-apple-darwin
      os: osx
    
cache:
  - cargo
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo
  
branches:
  only:
    # release tags
    - /^\d+\.\d+\.\d+.*$/
    - master
  
before_install:
  - set -e
  - rustup self update

install:
  - sh ci/install.sh
  - source ~/.cargo/env || true

script:
  - bash ci/script.sh

after_script: set +e

before_deploy:
  - sh ci/before_deploy.sh
  
deploy:
  - provider: releases
    api_key:
      secure: "XjfELzvB+5jAByX0QllG3zIYQq7kX95dd4rNPjaw7RdjHyuXCldTBHsumdL4W/cHUAGT1eCC0ls/EZGRKqM1utARSpEN83XCVl8Wd6+9ndaLR7PrCm2R+OSBnjUbp5FDrI5A8a2TIMh2cQrcotiAYCtwYatMufHHFFm/wzVHI+20FiF3GDGLBJdv8KC+I6GzIWGtDA5yU0jA9/zXQjin1xLi2HdQPaQk80F3pNDWmZUn9X2iMeHYaZJ/0HkbrB4oq35DG/bX8xAG+BwxE1/Cn62+TNdv8WOzsq78WGHvsfQ7A3Z6bWc1ixxDH/L0H2Vs8HJiMD1LrXmNOYuLV/RwwaY88vyS/Ef9MDP6IwUXGBauuVIwNfJ2GZ1t4kJ9qctM3aoffezT8zbahCyQLnAVW1OngqEQ5owdp26H3ykMPnaK1QbWQR3KlpsOuAQkVMtVWbH9MxB5sE9AkE1VR6utD//Bfho7/e2buGXkQ/SMewDBK8lrde/EIgU+cv9ziGkyUu4Vcr542UU+BNl55BufgXRNx4Qr1v/Y89aq2q/8EBUUOwp6lYLpKJ2w1ldVxB2FHDm2vZUEJt/S+hiqOptKuzNOSiQ72yePO7Ctkc0LLplZtUIYZ1oTl4PkTdS8uSdAC9LxV4CnWI2pAL4XhcENrIq4sWUQ9T89b1Ca89GEpB8="
    file_glob: true
    file: $CRATE_NAME-$TRAVIS_TAG-$TARGET.*
    on:
      condition: $TRAVIS_RUST_VERSION = stable && -n "$TARGET"
      tags: true
    skip_cleanup: true
